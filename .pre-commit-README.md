# Pre-commit Hooks for DynamicFunctioneer

This document explains the pre-commit hooks configured for this project and how to use them.

## What are Pre-commit Hooks?

Pre-commit hooks are automated checks that run before each git commit. They help maintain code quality by:
- Catching formatting issues before they reach the repository
- Running linting and type checking automatically
- Executing fast tests to catch obvious bugs
- Preventing common mistakes (e.g., committing large files, debug code)

## Installation

### 1. Install Pre-commit

Pre-commit is included in the dev dependencies:

```bash
# Install all dev dependencies
pip install -e ".[dev]"

# Or install pre-commit separately
pip install pre-commit
```

### 2. Install Git Hooks

After installing pre-commit, install the git hooks:

```bash
pre-commit install
```

This creates hooks in `.git/hooks/` that will run automatically.

## Hooks Configured

The following hooks run on every commit:

### 1. General File Checks
- **trailing-whitespace**: Remove trailing whitespace
- **end-of-file-fixer**: Ensure files end with a newline
- **check-yaml**: Validate YAML files
- **check-toml**: Validate TOML files
- **check-json**: Validate JSON files
- **check-added-large-files**: Prevent files > 1MB from being committed
- **check-merge-conflict**: Detect merge conflict markers
- **check-case-conflict**: Detect case-sensitive filename conflicts
- **detect-private-key**: Prevent committing private keys
- **mixed-line-ending**: Standardize line endings to LF

### 2. Code Formatting

**Black** - Python code formatter:
- Line length: 127 characters
- Formats code to PEP 8 standard
- Automatically fixes formatting issues

**isort** - Import statement organizer:
- Sorts imports alphabetically
- Groups imports by category (stdlib, third-party, local)
- Compatible with Black formatting

### 3. Linting

**Flake8** - Style and quality checker:
- Checks PEP 8 compliance
- Detects unused imports and variables
- Finds common bugs with flake8-bugbear
- Checks docstrings with flake8-docstrings
- Max line length: 127
- Ignores: E203, E501, W503 (conflicts with Black)

### 4. Type Checking

**Mypy** - Static type checker:
- Verifies type hints
- Catches type errors before runtime
- Configured to ignore missing imports
- Skips tests/ and trials/ directories

### 5. Security

**Bandit** - Security issue scanner:
- Detects common security vulnerabilities
- Checks for hardcoded passwords
- Identifies insecure function calls
- Skips tests (allows assert statements)

### 6. Python Code Checks

**pygrep-hooks** - Pattern-based checks:
- Prevents blanket `noqa` comments
- Detects use of `eval()`
- Finds deprecated logging methods
- Ensures type annotations are used

### 7. Fast Unit Tests

**pytest-check** - Runs fast unit tests:
- Executes tests in `tests/unit/`
- Skips slow tests (marked with `@pytest.mark.slow`)
- Stops at first failure (`--maxfail=1`)
- Provides quick feedback before commit

## Usage

### Automatic Running

Once installed, hooks run automatically when you commit:

```bash
git add .
git commit -m "Your commit message"
# Hooks run here automatically
```

If any hook fails:
1. The commit is aborted
2. You'll see which checks failed
3. Some hooks auto-fix issues (black, isort, trailing-whitespace)
4. Review the changes and stage them
5. Try committing again

### Manual Running

Run all hooks on all files:
```bash
pre-commit run --all-files
```

Run specific hook:
```bash
pre-commit run black --all-files
pre-commit run flake8 --all-files
pre-commit run pytest-check
```

Run on specific files:
```bash
pre-commit run --files path/to/file.py
```

### Skipping Hooks

**Not recommended**, but sometimes necessary:

```bash
# Skip all hooks for one commit
git commit --no-verify -m "Emergency fix"

# Skip specific hook by setting environment variable
SKIP=pytest-check git commit -m "WIP: tests not ready"
```

### Updating Hooks

Update to latest versions:
```bash
pre-commit autoupdate
```

This updates the `rev` values in `.pre-commit-config.yaml`.

## Configuration Files

### `.pre-commit-config.yaml`
Main configuration for pre-commit hooks. Defines:
- Which hooks to run
- Hook versions
- Hook arguments
- Files to exclude

### `pyproject.toml`
Contains tool-specific configurations:
- `[tool.black]` - Black formatter settings
- `[tool.isort]` - Import sorting settings
- `[tool.bandit]` - Security check settings
- `[tool.mypy]` - Type checking settings

### `pytest.ini`
Pytest configuration for test execution during pre-commit.

## Common Workflows

### First Time Setup

```bash
# Clone repository
git clone <repo-url>
cd DynamicFunctioneer

# Install dependencies
pip install -e ".[dev]"

# Install hooks
pre-commit install

# Run once to download hook environments
pre-commit run --all-files
```

### Daily Development

```bash
# Make changes
vim dynamic_functioneer/models/some_file.py

# Stage changes
git add dynamic_functioneer/models/some_file.py

# Commit (hooks run automatically)
git commit -m "Add new feature"

# If hooks fail, fix issues and try again
git add .
git commit -m "Add new feature"
```

### Before Pull Request

```bash
# Run all checks manually
pre-commit run --all-files

# Run full test suite
pytest

# Check coverage
pytest --cov=dynamic_functioneer --cov-report=term-missing

# Format all code
black dynamic_functioneer tests
isort dynamic_functioneer tests
```

## Troubleshooting

### Hook Installation Failed

```bash
# Reinstall hooks
pre-commit uninstall
pre-commit install

# Clear cache and reinstall
pre-commit clean
pre-commit install --install-hooks
```

### Hook Runs Too Slowly

```bash
# Skip slow hooks during development
SKIP=pytest-check git commit -m "WIP"

# Or disable specific tests in pytest.ini
```

### Hook Fails But Changes Look Correct

Some hooks auto-fix files:
```bash
# After black/isort auto-fix
git add -u
git commit -m "Your message"
```

### Conflicts Between Hooks

Our configuration ensures compatibility:
- Black and isort use same line length (127)
- Flake8 ignores rules that conflict with Black
- All tools configured in pyproject.toml

### Pre-commit Not Running

```bash
# Verify installation
pre-commit --version

# Check if hooks are installed
ls -la .git/hooks/pre-commit

# Reinstall if missing
pre-commit install
```

### Can't Commit Due to Test Failures

Options:
1. Fix the failing tests (recommended)
2. Skip pytest hook: `SKIP=pytest-check git commit -m "..."`
3. Skip all hooks: `git commit --no-verify -m "..."` (not recommended)

## Best Practices

1. **Don't skip hooks regularly**: They catch real issues
2. **Run manually before PR**: `pre-commit run --all-files`
3. **Keep hooks updated**: `pre-commit autoupdate` monthly
4. **Fix auto-formatted code**: Review black/isort changes
5. **Add new checks as needed**: Edit `.pre-commit-config.yaml`
6. **Commit often**: Quick feedback from hooks
7. **Test hooks locally**: Before pushing to CI

## Integration with CI/CD

Pre-commit hooks provide **local** checking. The CI pipeline (`.github/workflows/tests.yml`) provides **remote** verification:

| Check | Pre-commit (Local) | CI (Remote) |
|-------|-------------------|-------------|
| Fast unit tests | ✓ | ✓ (all tests) |
| Formatting | ✓ | ✓ |
| Linting | ✓ | ✓ |
| Type checking | ✓ | ✓ |
| Integration tests | ✗ | ✓ |
| Multiple Python versions | ✗ | ✓ |
| Coverage reporting | ✗ | ✓ |

Pre-commit provides fast feedback (seconds), CI provides comprehensive checking (minutes).

## Customization

### Adding a New Hook

Edit `.pre-commit-config.yaml`:

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: your-new-hook
        args: ['--your-arg']
```

Then update:
```bash
pre-commit install --install-hooks
```

### Disabling a Hook

Comment out in `.pre-commit-config.yaml`:

```yaml
# - id: hook-to-disable
```

Or skip permanently:
```bash
SKIP=hook-name git commit -m "..."
```

### Modifying Hook Behavior

Edit hook arguments in `.pre-commit-config.yaml` or tool configuration in `pyproject.toml`.

## Additional Resources

- [Pre-commit Documentation](https://pre-commit.com/)
- [Black Documentation](https://black.readthedocs.io/)
- [isort Documentation](https://pycqa.github.io/isort/)
- [Flake8 Documentation](https://flake8.pycqa.org/)
- [Mypy Documentation](https://mypy.readthedocs.io/)
- [Bandit Documentation](https://bandit.readthedocs.io/)
- Project Testing Guide: `TESTING.md`
